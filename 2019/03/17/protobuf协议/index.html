<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="什么是protocol buffersProtocol buffers是Google的与语言无关、平台无关、可扩展的序列化结构数据，比xml更小、更简单、更快。用户定义数据的结构，通过特殊生成的代码，然后就可以使用多种语言(包括C++、C#、Dart、Go、Java、Python)来读写结构化数据了"/>
    

    <!--Author-->
    
        <meta name="author" content="Leitty"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Protobuf协议"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="什么是protocol buffersProtocol buffers是Google的与语言无关、平台无关、可扩展的序列化结构数据，比xml更小、更简单、更快。用户定义数据的结构，通过特殊生成的代码，然后就可以使用多种语言(包括C++、C#、Dart、Go、Java、Python)来读写结构化数据了"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Leitty Blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="https://leitty.github.io/img/home-bg.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="https://leitty.github.io/img/home-bg.jpg"/>
    

    <!-- Title -->
    
    <title>Protobuf协议 - Leitty Blog</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Configurable Title</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://leitty.github.io/">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Protobuf协议</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2019-03-17
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/Golang/">#Golang</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h2 id="什么是protocol-buffers"><a href="#什么是protocol-buffers" class="headerlink" title="什么是protocol buffers"></a>什么是protocol buffers</h2><p>Protocol buffers是Google的与语言无关、平台无关、可扩展的序列化结构数据，比xml更小、更简单、更快。<br>用户定义数据的结构，通过特殊生成的代码，然后就可以使用多种语言(包括C++、C#、Dart、Go、Java、Python)来读写结构化数据了。</p>
<h2 id="使用protocol-buffers"><a href="#使用protocol-buffers" class="headerlink" title="使用protocol buffers"></a>使用protocol buffers</h2><p>这里以Go为例来进行演示，其他语言请查询<a href="https://developers.google.com/protocol-buffers/docs/tutorials" target="_blank" rel="noopener">官方文档</a>，本例使用proto3版本。</p>
<p>具体包括以下三步：</p>
<ul>
<li>定义message格式的.proto文件</li>
<li>使用protocol buffer编译器</li>
<li>使用Go protocol buffer API来读写message</li>
</ul>
<h3 id="定义protocol格式"><a href="#定义protocol格式" class="headerlink" title="定义protocol格式"></a>定义protocol格式</h3><p>.proto文件的定义比较简单：为每个想序列化的数据结构新增一个message，并给与每一个field一个名字和类型。为了防止命名冲突.proto文件以包声明开始。如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line">package tutorial;</span><br><span class="line"></span><br><span class="line">import &quot;google/protobuf/timestamp.proto&quot;;</span><br></pre></td></tr></table></figure>
<p>其后定义message：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">message Person &#123;</span><br><span class="line">  string name = 1;</span><br><span class="line">  int32 id = 2;  // Unique ID number for this person.</span><br><span class="line">  string email = 3;</span><br><span class="line"></span><br><span class="line">  enum PhoneType &#123;</span><br><span class="line">    MOBILE = 0;</span><br><span class="line">    HOME = 1;</span><br><span class="line">    WORK = 2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  message PhoneNumber &#123;</span><br><span class="line">    string number = 1;</span><br><span class="line">    PhoneType type = 2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  repeated PhoneNumber phones = 4;</span><br><span class="line"></span><br><span class="line">  google.protobuf.Timestamp last_updated = 5;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Our address book file is just one of these.</span><br><span class="line">message AddressBook &#123;</span><br><span class="line">  repeated Person people = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一个message包含一系列值类型。很多简单的标准数据类型在.proto文件中是可以使用的，其中包括<code>bool</code>、<code>int32</code>、<code>float</code>、<code>double</code>、<code>string</code>。当然还有其他的类型，可以<a href="https://developers.google.com/protocol-buffers/docs/proto3" target="_blank" rel="noopener">参考</a></p>
<p>在上面的例子中，<code>Person</code>包含<code>PhoneNumber</code>，<code>AddressBook</code>包含<code>Person</code>，我们可以嵌套定义message类型，如<code>PhoneNumber</code>就是嵌套在<code>Person</code>中定义，可以定义枚举类型，如<code>PhoneType</code>。</p>
<p>每个元素的”=1”，”=2”标签是二进制编码后的唯一标识，1-15标签需要的编码数比15以后的数据要少一个byte，所以一种常用的优化方式是用1-15来标记常用的元素和重复的元素(数组)，16以后的tags来标记使用频率少的元素。重复field中的每个元素都需要重新编码，比如<code>PhoneNumber</code>内tags重现从1开始，所以重复field也是一种常规的优化方法。</p>
<p>如果一个field值没有定义，一般会有默认值：numeric类型的默认值为0，strings类型的默认值是空字符串，bools类型是false，嵌套的messages默认值为”default instance”或者”prototype”，是没有元素的。</p>
<p>如果一个field是repeated的，这个field可以重复若干次。它在protocal buffer中的顺序将保留。可以将其理解为动态大小的数组。</p>
<h3 id="编译protocol-buffers"><a href="#编译protocol-buffers" class="headerlink" title="编译protocol buffers"></a>编译protocol buffers</h3><p>在上面的步骤中，我们得到了<code>AddressBook.proto</code>文件，现在我们来完成.proto文件的编译：</p>
<h4 id="下载编译器"><a href="#下载编译器" class="headerlink" title="下载编译器"></a>下载编译器</h4><p><a href="https://developers.google.com/protocol-buffers/docs/downloads.html" target="_blank" rel="noopener">编译器地址</a></p>
<p>在linux中的安装如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 下载</span><br><span class="line">wget https://github.com/protocolbuffers/protobuf/releases/download/v3.6.1/protobuf-all-3.6.1.tar.gz</span><br><span class="line"></span><br><span class="line"># 解压</span><br><span class="line">tar xvf protobuf-all-3.6.1.tar.gz</span><br><span class="line">cd protobuf-3.6.1/</span><br><span class="line"></span><br><span class="line"># 生成configure</span><br><span class="line">./autogen.sh</span><br><span class="line"></span><br><span class="line"># 编译安装</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make check</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p>
<p>注意：./autogen.sh时可能报错，请确保安装了<code>automake</code>，对于未安装的请执行<code>apt-get install automake</code>或者<code>yum install automake</code>，遇到<code>libtoolize</code>报错，请安装<code>apt-get install libtool*</code>或者<code>yum install libtool*</code>。遇到报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc: error while loading shared libraries: libprotoc.so.17: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure></p>
<p>将/usr/local/lib加到环境变量中:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export LD_LIBRARY_PATH=/usr/local/lib</span><br></pre></td></tr></table></figure></p>
<p>安装结束后可以使用<code>protoc --version</code>查看protoc版本。</p>
<p>windows的protoc更为简单：</p>
<p>下载windows版的protoc：protoc-3.6.1-win32.zip，解压后将解压目录加到环境变量中，即可。可以运行<code>protoc --version</code>查看protoc版本。</p>
<h4 id="安装Go-protocol-buffers插件"><a href="#安装Go-protocol-buffers插件" class="headerlink" title="安装Go protocol buffers插件"></a>安装Go protocol buffers插件</h4><p>运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/golang/protobuf/protoc-gen-go</span><br></pre></td></tr></table></figure></p>
<p>运行结束后可以在$GOPATH/bin中看到<code>protoc-gen-go</code>文件。</p>
<h4 id="编译-protoc文件"><a href="#编译-protoc文件" class="headerlink" title="编译.protoc文件"></a>编译.protoc文件</h4><p>在当前<code>AddressBook.proto</code>文件目录中，运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc --go_out=. AddressBook.proto</span><br></pre></td></tr></table></figure></p>
<p>运行结束后，会在本地生成AddressBook.pb.go文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; 详细命令的protoc：</span><br><span class="line">&gt; protoc -I=$SRC_DIR --go_out=$DST_DIR $SRC_DIR/addressbook.proto</span><br></pre></td></tr></table></figure>
<h3 id="Protocol-Buffer-API"><a href="#Protocol-Buffer-API" class="headerlink" title="Protocol Buffer API"></a>Protocol Buffer API</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;github.com/golang/protobuf/proto&quot;</span><br><span class="line"></span><br><span class="line">	pb &quot;leitty/rpc/protocol/protobuf&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	//初始化一个Person</span><br><span class="line">	p := pb.Person&#123;</span><br><span class="line">		Id: 1,</span><br><span class="line">		Name: &quot;Mike&quot;,</span><br><span class="line">		Email: &quot;mike@test.com&quot;,</span><br><span class="line">		Phones: []*pb.Person_PhoneNumber&#123;</span><br><span class="line">			&#123;Number: &quot;123&quot;, Type: pb.Person_HOME&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	// 查看p中的Email</span><br><span class="line">	fmt.Println(p.GetEmail())</span><br><span class="line"></span><br><span class="line">	//使用Marshal函数对p进行编码</span><br><span class="line">	data, err := proto.Marshal(&amp;p)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	//解码data</span><br><span class="line">	var target pb.Person</span><br><span class="line">	err = proto.Unmarshal(data,&amp;target)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(target.GetName())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://developers.google.com/protocol-buffers/" target="_blank" rel="noopener">https://developers.google.com/protocol-buffers/</a></p>
<p><a href="https://developers.google.com/protocol-buffers/docs/tutorials" target="_blank" rel="noopener">https://developers.google.com/protocol-buffers/docs/tutorials</a></p>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/Leitty/Leitty.github.io" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    
                        <li>
                            <a href="mailto:gleiying@gmail.com" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2019 Leitty<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>